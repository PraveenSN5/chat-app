<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat App</title>
</head>
<body>
  <div id="joinChatDiv">
    <input id="usernameInput" placeholder="Enter username" />
    <input id="roomInput" placeholder="Enter room" />
    <button id="joinBtn">Join Chat</button>
  </div>

  <div id="chatDiv" style="display:none;">
    <div id="messages"></div>
    <input id="messageInput" placeholder="Enter message" />
    <button id="sendBtn">Send</button>
  </div>
  <div class="chat-container">
  <header class="chat-header">Optimistic Chat</header>
  
  <div class="chat-messages" id="chat-messages">
    <!-- Messages get appended here -->
    <div class="message system">
      <span class="text">Welcome to the chat!</span>
      <span class="time">12:00 PM</span>
    </div>
  </div>
  
  <form class="chat-form" id="chat-form">
    <input type="text" id="msg" autocomplete="off" placeholder="Type your message..." />
    <button type="submit">Send</button>
  </form>
</div>


  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const joinChatDiv = document.getElementById('joinChatDiv');
    const chatDiv = document.getElementById('chatDiv');
    const usernameInput = document.getElementById('usernameInput');
    const roomInput = document.getElementById('roomInput');
    const joinBtn = document.getElementById('joinBtn');
    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    joinBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      const room = roomInput.value.trim();
      if (!username || !room) {
        alert('Please enter both username and room.');
        return;
      }
      // Emit joinRoom event
      socket.emit('joinRoom', { username, room });
    });

    // Handle usernameTaken event from server
    socket.on('usernameTaken', () => {
      alert('Username is already taken. Please choose another username.');
      usernameInput.value = '';
      usernameInput.focus();
    });

    // On successful join, show chat and hide join form
    socket.on('message', (message) => {
      // Show message in chat window
      const div = document.createElement('div');
      div.textContent = `[${message.time}] ${message.username}: ${message.text}`;
      messages.appendChild(div);

      // If this is system message about join and chatDiv is hidden, show chatDiv
      if (message.text.includes('joined the room.') && chatDiv.style.display === 'none') {
        joinChatDiv.style.display = 'none';
        chatDiv.style.display = 'block';
      }
    });

    sendBtn.addEventListener('click', () => {
      const msg = messageInput.value.trim();
      if (!msg) return;
      socket.emit('chatMessage', msg);
      messageInput.value = '';
      messageInput.focus();
    });

    // Optional: handle Enter key to send message
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });
  </script>
</body>
</html>
